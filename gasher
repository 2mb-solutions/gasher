#!/bin/bash

clientName="${0##*/}"
clientName="${clientName^}"

show_help()
{
cat << EOF
$clientName, a 2MB Solutions product.
 released under the GPL version 3 or later.
For more great stuff, visit http://2mb.solutions
Solutions at the speed of AWESOME!

Usage:
$clientName -h --help: This help screen.
$clientName -m --mentions: Read your mensions (replies).
$clientName -p --post: Post to your node.
$clientName -t --timeline: Read your timeline.
EOF
}

# Set up the configuration directory information
if [ -z "$XDG_USER_HOME" ]; then
    configPath="$HOME/.config/gasher"
else
    configPath="$$XDG_UER_HOME/gasher"
fi
if [ ! -d "$configPath" ]; then
    mkdir -p "$configPath"
fi

# Create settings if they do not exist.
if [ ! -f "$configPath/config" ]; then
    echo "Welcome to $clientName! A 2MB Solutions product."
    echo "It appears you do not have a GNU Social account configured."
    echo "Setup is quick and painless."
    echo
    read -p "Please enter your GNU Social username, This is the part before the @ symble: " userName
    read -p "Please enter your GNU Social node, This is the part after the @ symble and resimble a web address: " -e -i social.2mb.solutions userNode
    read -sp "Please enter your GNU Social password. This is optional, but if not included, you will be prompted for it every time you do anything with $clientName: " password
    echo
    echo -e "userName=$userName\nuserNode=$userNode" > "$configPath/config"
    if [ "$password" ]; then
        echo "password=$password" >> "$configPath/config"
    fi
    if [ $? -eq 0 ] ; then
        echo "Thanks, setup is now complete. Welcome to $clientName $userName@$userNode."
    fi
fi

# read settings
source "$configPath/config"
# Pager is set here, to allow the PAGER variable to be set in either invironment or gasher's config
if [ -z "$PAGER" ]; then
PAGER=more
fi

# actions are based on $1
case "$1" in
"-p" | "--post")
shift
status="$*"
result="$(curl -s -u "$userName:$password" -d status="$status" -d source="$clientName" $userNode/api/statuses/update.xml)"
error="$(echo "$result" | grep '^ <error>' | sed -e 's/<error>//' -e 's/<\/error>//' -e 's/^ //')"
if [ -n "$error" ]; then
echo "$error"
exit 1
fi
reply="$(echo "$result" | grep '^ <in_reply_to>' | sed -e 's/<in_reply_to>//' -e 's/<\/in_reply_to>//' -e 's/^ //')"
if [ -n "$reply" ]; then
echo "Status posted in reply to $reply."
else
echo "Status posted"
fi
;;
"-m" | "--mentions")
result="$(curl -s -u "$userName:$password" $userNode/api/statuses/mentions_timeline.xml)"
echo "$result" | grep -e '^  <text>' -e '^  <created_at>' -e '^  <source>' | sed -e 's/^  <text>//' -e 's/<\/text>$//' -e 's/^  <created_at>/Posted: /' -e 's/<\/created_at>//' -e  's/^  <source>/From /' -e 's/<\/source>$//' | $PAGER
;;
"-t" | "--timeline")
result="$(curl -s -u "$userName:$password" $userNode/api/statuses/user_timeline.xml)"
echo "$result" | grep -e '^  <text>' -e '^  <created_at>' -e '^  <source>' | sed -e 's/^  <text>//' -e 's/<\/text>$//' -e 's/^  <created_at>/Posted: /' -e 's/<\/created_at>//' -e  's/^  <source>/From /' -e 's/<\/source>$//' | $PAGER
;;
*)
show_help
esac
exit 0
